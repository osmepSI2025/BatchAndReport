@page
@model EContractDashboardModel
@{
    ViewData["Title"] = "E-Contract Dashboard";
    Layout = "_Layout1"; // ensure this is set to your layout
}
<style>
    @@media print {
    .container {
        width: 210mm !important;   /* A4 width */
        min-height: 297mm !important; /* A4 height */
        margin: 0 auto !important;
        background: #fff !important;
        box-shadow: none !important;
    }
}
    .a4-export {
        width: 210mm !important;
        min-height: 297mm !important;
        margin: 0 auto !important;
        background: #fff !important;
        box-shadow: none !important;
    }
    .export-scale {
        transform: scale(0.7);           /* ปรับขนาดตามต้องการ */
        transform-origin: top left;
        width: 1428px;                   /* 1122 / 0.7 */
        height: 1133px;                  /* 793 / 0.7 */
    }
</style>
<h2 class="fw-bold mb-4">E-Contract Dashboard</h2>

<div class="container">
    <div class="row mb-5">
        <div class="col-md-6">
            <div class="card shadow-sm p-3 mb-3">
                <h5 class="card-title">ประเภทคู่สัญญา</h5>
                <canvas id="contractTypeChart"  height="250"></canvas>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card shadow-sm p-3 mb-3">
                <h5 class="card-title">สถานะเอกสาร</h5>
                <canvas id="documentStatusChart"  height="250"></canvas>
            </div>
        </div>
    </div>

    <div class="row mb-5">
        <div class="col-md-6">
            <div class="card shadow-sm p-3 mb-3">
                <h5 class="card-title">สถานะสัญญา</h5>
                <canvas id="contractStatusChart" height="250"></canvas>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card shadow-sm p-3 mb-3">
                <h5 class="card-title">KPI ตรวจสอบกฎหมาย</h5>
                <table class="table table-bordered text-center">
                    <thead class="table-light">
                        <tr>
                            <th>เจ้าหน้าที่</th>
                            <th>รอตรวจสอบ</th>
                            <th>ตรวจสอบเสร็จสิ้น</th>
                            <th>รวมทั้งสิ้น</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var item in Model.LegalKpiChart)
                        {
                            <tr>
                                <td>@item.Owner</td>
                                <td>@item.Pending</td>
                                <td>@item.Completed</td>
                                <td>@item.Total</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="container">
    <div class="col-md-12 text-end">
        <h5 class="card-title">Export</h5>

        <button class="btn btn-outline-primary btn-sm me-2" onclick="exportDashboardPdf()">PDF</button>
@*         <a asp-page="/EContractDashboard" asp-page-handler="ExportPdf" class="btn btn-outline-primary btn-sm me-2" target="_blank">PDF</a>
 *@       
 <a asp-page="/EContractDashboard" asp-page-handler="ExportXls" class="btn btn-outline-success btn-sm me-2" target="_blank">XLS</a>
        <a asp-page="/EContractDashboard" asp-page-handler="ExportTxt" class="btn btn-outline-secondary btn-sm me-2" target="_blank">TXT</a>
@*         <a asp-page="/EContractDashboard" asp-page-handler="ExportJpeg" class="btn btn-outline-warning btn-sm" target="_blank">JPEG</a> *@
        <button class="btn btn-outline-warning btn-sm" onclick="exportDashboardJpeg()">JPEG</button>

    </div>
</div>
@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script>
        function renderDonutChart(chartId, labels, data, colors) {
            if (!labels || !data || labels.length === 0 || data.length === 0) return;

            new Chart(document.getElementById(chartId), {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });
        }

        renderDonutChart("contractTypeChart",
            @Html.Raw(Json.Serialize(Model.ContractTypeChart.Select(x => x.Label))),
            @Html.Raw(Json.Serialize(Model.ContractTypeChart.Select(x => x.Value))),
            ['#CCE5FF', '#99CCFF', '#6699CC', '#336699']
        );

        renderDonutChart("documentStatusChart",
            @Html.Raw(Json.Serialize(Model.DocumentStatusChart.Select(x => x.Label))),
            @Html.Raw(Json.Serialize(Model.DocumentStatusChart.Select(x => x.Value))),
            ['#E6D4FF', '#C8A2C8', '#8A2BE2', '#4B0082']
        );

        renderDonutChart("contractStatusChart",
            @Html.Raw(Json.Serialize(Model.ContractStatusChart.Select(x => x.Label))),
            @Html.Raw(Json.Serialize(Model.ContractStatusChart.Select(x => x.Value))),
            ['#C5F2D6', '#90EE90', '#2E8B57', '#006400']
        );
    </script>


    <script>
        // Step 1: Export as JPEG (with optional callback)
        function exportDashboardJpeg(callback) {
            var element = document.querySelector('.container');
            html2canvas(element, {backgroundColor: '#fff', scale: 2}).then(function(canvas) {
                var imgData = canvas.toDataURL('image/jpeg', 0.98);
                if (callback) {
                    callback(imgData);
                } else {
                    var link = document.createElement('a');
                    link.download = 'EContractDashboard.jpg';
                    link.href = imgData;
                    link.click();
                }
            });
        }

        // Step 2: Export as PDF (calls JPEG export, then inserts into PDF)
        function exportDashboardPdf() {
            var element = document.querySelector('.container');
            html2canvas(element, {
                backgroundColor: '#fff',
                scale: 2
            }).then(function(canvas) {
                var imgData = canvas.toDataURL('image/jpeg', 0.98);

                // ขนาด pixel จริงของภาพ
                var imgWidth = canvas.width;
                var imgHeight = canvas.height;

                // ขนาด A4 portrait (mm)
                var pdf = new window.jspdf.jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: 'a4'
                });
                var pageWidth = pdf.internal.pageSize.getWidth();
                var pageHeight = pdf.internal.pageSize.getHeight();

                // คำนวณอัตราส่วนให้ภาพไม่ยืด/ไม่หด
                var ratio = Math.min(pageWidth / imgWidth, pageHeight / imgHeight);
                var printWidth = imgWidth * ratio;
                var printHeight = imgHeight * ratio;
                var marginX = (pageWidth - printWidth) / 2;
                var marginY = (pageHeight - printHeight) / 2;

                pdf.addImage(imgData, 'JPEG', marginX, marginY, printWidth, printHeight);
                pdf.save('EContractDashboard.pdf');
            });
        }
    </script>


}
